version: 0.1.{build}
pull_requests:
  do_not_increment_build_number: true

environment:
  PGUSER: postgres
  PGPASSWORD: Password12!
  PGSQL_PATH: C:\Program Files\PostgreSQL\9.6
  POSTGRES_ENV_POSTGRES_USER: postgres
  POSTGRES_ENV_POSTGRES_PASSWORD: Password12!
  MSVC_VERSION: "Visual Studio 10 Win64"

  matrix:
    - PYTHON: C:\Python27-x64
    - PYTHON: C:\Python36-x64
      
services:
  - postgresql

before_test:
  - SET PATH=%PGSQL_PATH%\bin;%PATH%
  - createdb pacifica_metadata

install:
  - ps: 'Invoke-WebRequest -Uri "https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.8.zip" -OutFile "elasticsearch.zip"'
  - ps: 'Expand-Archive "elasticsearch.zip" -DestinationPath "C:\elasticsearch"'
  - ps: 'Start-Process C:\elasticsearch\elasticsearch-5.6.8\bin\elasticsearch'
  - '%PYTHON%\python.exe -m pip install -r requirements-dev.txt'
  - cp "c:\Program Files (x86)\Microsoft Visual Studio 10.0\VC\include\stdint.h" "C:\Users\appveyor\AppData\Local\Programs\Common\Microsoft\Visual C++ for Python\9.0\VC\include\stdint.h"

build: off

test_script:
  - ps: >
      & "$env:PYTHON\python.exe" -m coverage run --include="metadata/*" -m pytest -v metadata/orm metadata/elastic metadata/test;
      & "$env:PYTHON\python.exe" -m coverage run --include="metadata/*" -a -m pytest -v metadata/rest;
      & "$env:PYTHON\python.exe" -m coverage run --include="metadata/*" -a MetadataServer.py --stop-after-a-moment;
      & "$env:PYTHON\python.exe" -m coverage report --show-missing --fail-under 100;
